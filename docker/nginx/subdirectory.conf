# Nginx configuration for subdirectory deployment
# This configuration is for running the application at: https://dev.nexxtecnologia.com.br/Controle-Financeiro

server {
    listen 80;
    server_name _;
    
    # Application running in subdirectory
    location /Controle-Financeiro {
        # Remove the subdirectory prefix for Laravel
        rewrite ^/Controle-Financeiro/(.*)$ /$1 break;
        
        # Try files in Laravel public directory
        try_files $uri $uri/ @laravel;
    }
    
    # Handle Laravel routing
    location @laravel {
        rewrite ^/(.*)$ /index.php?$query_string last;
    }
    
    # PHP-FPM configuration
    location ~ \.php$ {
        # Only process PHP files within our subdirectory context
        fastcgi_pass app:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/html/public$fastcgi_script_name;
        include fastcgi_params;
        
        # Important: Set the correct document root and script name
        fastcgi_param DOCUMENT_ROOT /var/www/html/public;
        fastcgi_param SCRIPT_NAME $fastcgi_script_name;
        
        # Security
        fastcgi_hide_header X-Powered-By;
        
        # Timeouts and buffers
        fastcgi_read_timeout 300;
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
        
        # Headers for Laravel to understand the subdirectory
        fastcgi_param HTTP_X_FORWARDED_PROTO $scheme;
        fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
        fastcgi_param HTTP_X_REAL_IP $remote_addr;
        fastcgi_param HTTP_X_FORWARDED_PREFIX /Controle-Financeiro;
    }

    # Static files for the application
    location ~ ^/Controle-Financeiro/.*\.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg|webp)$ {
        # Remove subdirectory prefix and serve from public
        rewrite ^/Controle-Financeiro/(.*)$ /$1 break;
        root /var/www/html/public;
        
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary "Accept-Encoding";
        access_log off;
    }

    # Health check for the application
    location /Controle-Financeiro/health {
        rewrite ^/Controle-Financeiro/health$ /health break;
        fastcgi_pass app:9000;
        fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
        fastcgi_param SCRIPT_NAME /index.php;
        fastcgi_param REQUEST_URI /health;
        include fastcgi_params;
        access_log off;
    }

    # Deny access to sensitive files
    location ~ ^/Controle-Financeiro/(storage|bootstrap|\.env) {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Default location (for other applications on the same server)
    location / {
        # This allows other applications to run on the same server
        return 404;
    }

    # Log format
    access_log /var/log/nginx/subdirectory-access.log combined;
    error_log /var/log/nginx/subdirectory-error.log warn;
}